<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles/config.css">
    <link rel="stylesheet" href="public/styles/analytics.css">
    <script type="module" src="./toggleMode.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
    <title>Analytics Page</title>
    
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize the state from localStorage, defaulting to false (home page)
            let toggled = localStorage.getItem('toggled') === 'true';

            // Update the button text based on the initial state
            updateButtonText(toggled);

            // Trigger the button switch
            triggerSwitch();

            function triggerSwitch() {
                const toggleBtn = document.querySelector("#analyticsBtn");
            
                if (toggleBtn) {
                    console.log("‚úÖ Toggle button exists/found");

                    toggleBtn.addEventListener("click", () => {
                        console.log("üî• Toggle button clicked");
                        toggleState();
                    });
                } else {
                    console.warn("‚ùå Toggle Button not found. Check ID or ensure the button exists.");
                }
            }

            function toggleState() {
                // Toggle the state
                toggled = !toggled;

                // Save the new state to localStorage
                localStorage.setItem('toggled', toggled);
                console.log(`Current state of the browser's page is: ${localStorage.getItem('toggled')}`);

                // Update the button text
                updateButtonText(toggled);

                // Navigate to the appropriate page
                if (toggled) {
                    window.location.href = 'analytics.html';
                } else {
                    window.location.href = 'home.html';
                }
            }

            function updateButtonText(toggled) {
                const toggleBtn = document.querySelector("#analyticsBtn");
                if (toggleBtn) {
                    toggleBtn.textContent = toggled ? "Hide Analytics" : "View Analytics";
                }
            }
        });
    </script>
</head>
<body>
    <header class="home-header">
        <div class="leftNav">
            <img src="./images/default.jpg" id="profile-pic" style="border-radius: 50%;" alt="" width="50" height="50">
            <h1 class="welcome">Welcome <span id="username"></span> </h1>
        </div>
        <div class="rightNav">
            <ul class="UnorderedList">
                <li><button id="analyticsBtn">Hide Analytics</button></li>
                <li><button id="logoutBtn">LogOut</button></li>
            </ul>
        </div>
    </header>

    <section class="main">
        <!-- Table to Display Tasks -->
        <div class="table-container">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Tag</th>
                        <th>Color</th>
                        <th>Selected Boxes</th>
                        <th>Total Time</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    
        <!-- Charts for Analytics -->
        <div class="analytics">
            <h2>Analytics</h2>
            <div class="chart-container">
                <div class="chart">
                    <h3>Total Time Spent per Tag</h3>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart">
                    <h3>Task Distribution by Tag</h3>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="heatmap-container">
                <h3>Task Completion Over Time</h3>
                <div id="heatmap"></div>
            </div>
        </div>
    </section>

    <script type="module">
        // Get the URL parameters
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyClF_kUmfMyrxDqP_iuu7BgoqqTtX67JRY",
            authDomain: "valutracker-391c6.firebaseapp.com",
            databaseURL: "https://valutracker-391c6-default-rtdb.firebaseio.com",
            projectId: "valutracker-391c6",
            storageBucket: "valutracker-391c6.firebasestorage.app",
            messagingSenderId: "268267434732",
            appId: "1:268267434732:web:49e075d9a0b22df4c4abc9",
            measurementId: "G-X8RX5C4WKS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username');
        document.getElementById('username').textContent = username;

        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.addEventListener('click', () => {    
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        });

        const profilePic = document.getElementById("profile-pic");

        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("‚úÖ User signed in:", user.displayName, user.email, user.uid);
                window.userId = user.uid;

                // Set profile picture
                let checkPhotoInterval = setInterval(() => {
                    if (user.photoURL) {
                        console.log("üñº Found Profile Pic:", user.photoURL);
                        profilePic.src = user.photoURL;
                        clearInterval(checkPhotoInterval);
                    } else {
                        console.warn("‚ö† No photoURL found, using default.");
                        profilePic.src = "public/images/default.jpg";
                    }
                }, 100); 

                // Fetch tasks
                fetchTasks(user.uid);
            } else {
                console.warn("‚ùå No user is signed in.");
                window.location.href = 'index.html';
            }
        });

        // Function to fetch and display tasks for the current day
        function fetchTasks(userId) {
    const userTasksRef = ref(db, `userTasks/${userId}`);

    onValue(userTasksRef, (snapshot) => {
        console.log("Fetching tasks for user:", userId);
        console.log("üìå Snapshot Data:", snapshot.val());

        const tableBody = document.querySelector("#taskTable tbody");
        tableBody.innerHTML = "";

        const tagTimeMap = {};
        const tagCountMap = {};
        const tagColorMap = {};
        const selectedBoxesMap = {}; // Map to store selected boxes for heatmap

        if (snapshot.exists()) {
            const tasks = snapshot.val();
            const currentDate = new Date().toDateString(); // Get current date

            Object.values(tasks).forEach((taskId) => {
                const task = tasks[taskId];
                if (task.timestamp === undefined || task.timestamp === null) {
                    console.error('Timestamp is missing or invalid for task:', taskId);
                    return; // Skip tasks with missing or invalid timestamps
                }

                const taskDate = new Date(task.timestamp); // Parse timestamp to Date object

                // Check if the timestamp is valid
                if (isNaN(taskDate)) {
                    console.error('Invalid date format for task:', taskId, task.timestamp);
                    return; // Skip tasks with invalid timestamps
                }

                console.log("Task Date:", taskDate.toDateString());

                // Only process tasks for the current day by comparing the date part
                if (taskDate.toDateString() === currentDate) {
                    const taskText = task.task || "No task name";
                    const tag = task.tag || "No tag";
                    const color = task.color || "#CCCCCC";

                    tagColorMap[tag] = color;

                    const selectedBoxes = Array.isArray(task.selectedBoxes) ? task.selectedBoxes : [];
                    const totalTime = task.totalTime || 0; // Total time is in hours
                    const timestamp = task.timestamp ? new Date(task.timestamp).toLocaleString() : "N/A";

                    // Populate table
                    const row = document.createElement("tr");
                    row.innerHTML = `
                        <td>${taskText}</td>
                        <td>${tag}</td>
                        <td style="background-color: ${color};"></td>
                        <td>${selectedBoxes.join(", ")}</td>
                        <td>${totalTime}</td>
                        <td>${timestamp}</td>
                    `;
                    tableBody.appendChild(row);

                    // Aggregate data for charts
                    tagTimeMap[tag] = (tagTimeMap[tag] || 0) + totalTime; // Total time is in hours
                    tagCountMap[tag] = (tagCountMap[tag] || 0) + 1;

                    // Map selected boxes to their colors and tags
                    selectedBoxes.forEach(boxId => {
                        selectedBoxesMap[boxId] = { color, tag };
                    });
                }
            });

            // Update charts and heatmap
            updateCharts(tagTimeMap, tagCountMap, tagColorMap);
            updateHeatmap(selectedBoxesMap);
        } else {
            console.warn("‚ö† No tasks found for this user.");
        }
    });
}



        // Function to update charts dynamically with colors from Firebase data
        function updateCharts(tagTimeMap, tagCountMap, tagColorMap) {
            const barCtx = document.getElementById("barChart").getContext("2d");
            const pieCtx = document.getElementById("pieChart").getContext("2d");

            const tags = Object.keys(tagTimeMap);
            const totalTimeData = Object.values(tagTimeMap); // Total time is in hours
            const taskCountData = Object.values(tagCountMap);
            const tagColors = tags.map(tag => tagColorMap[tag] || "#CCCCCC");

            // Calculate the maximum time value for the y-axis
            const maxTime = Math.max(...totalTimeData, 0); // Total time is in hours
            const maxHours = Math.ceil(maxTime); // Maximum hours

            // Generate y-axis ticks dynamically
            const yAxisTicks = [];
            for (let i = 0; i <= maxHours; i += 0.5) { // Increment by 0.5 hours (30 minutes)
                yAxisTicks.push(i);
            }

            // Bar Chart - Total Time per Tag
            if (window.barChartInstance) {
                window.barChartInstance.destroy();
            }
            window.barChartInstance = new Chart(barCtx, {
                type: "bar",
                data: {
                    labels: tags,
                    datasets: [
                        {
                            label: "Total Time (hours)",
                            data: totalTimeData,
                            backgroundColor: tagColors,
                            borderColor: tagColors.map(color => color.replace(/0.7/, "1")),
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 0.5, // Set y-axis interval to 0.5 hours (30 minutes)
                                callback: (value) => {
                                    // Format the tick label as hours and minutes
                                    const hours = Math.floor(value);
                                    const minutes = (value % 1) * 60;
                                    return `${hours}h ${minutes}m`;
                                },
                                max: maxHours, // Set the maximum value for the y-axis
                            },
                        },
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.raw || 0;
                                    const hours = Math.floor(value);
                                    const minutes = (value % 1) * 60;
                                    return `${label}: ${hours}h ${minutes}m`;
                                },
                            },
                        },
                    },
                },
            });

            // Pie Chart - Task Count per Tag
            if (window.pieChartInstance) {
                window.pieChartInstance.destroy();
            }
            window.pieChartInstance = new Chart(pieCtx, {
                type: "pie",
                data: {
                    labels: tags,
                    datasets: [
                        {
                            label: "Task Distribution",
                            data: taskCountData,
                            backgroundColor: tagColors,
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value} tasks`;
                                },
                            },
                        },
                    },
                },
            });
        }

        // Function to update heatmap with user's colors and tooltips
        function updateHeatmap(selectedBoxesMap) {
            const heatmapContainer = document.getElementById("heatmap");
            heatmapContainer.innerHTML = ""; // Clear previous heatmap

            const heatmapGrid = document.createElement("div");
            heatmapGrid.className = "heatmap-grid";

            // Generate heatmap grid (48 boxes for 24 hours in 30-minute intervals)
            for (let i = 1; i <= 48; i++) {
                const box = document.createElement("div");
                box.className = "heatmap-box";
                box.id = `box-${i}`; // Assign ID to each box

                // Set color based on selectedBoxesMap
                if (selectedBoxesMap[i]) {
                    box.style.backgroundColor = selectedBoxesMap[i].color;
                    box.title = `Tag: ${selectedBoxesMap[i].tag}`; // Add tooltip for the tag
                } else {
                    box.style.backgroundColor = "rgba(0, 128, 0, 0.1)"; // Default color
                    box.title = "No task"; // Default tooltip
                }

                heatmapGrid.appendChild(box);
            }

            heatmapContainer.appendChild(heatmapGrid);
        }
    </script>
</body>
</html>