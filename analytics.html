<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="public/styles/config.css">
    <link rel="stylesheet" href="public/styles/analytics.css">
    <script type="module" src="./toggleMode.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
    <title>Analytics Page</title>
    
    <script defer>
        document.addEventListener("DOMContentLoaded", () => {
            // Initialize the state from localStorage, defaulting to false (home page)
            let toggled = localStorage.getItem('toggled') === 'true' || 'false';

            // Trigger the button switch
            triggerSwitch();


            function triggerSwitch() {
                const toggleBtn = document.querySelector("#analyticsBtn");
            
                if (toggleBtn) {
                    console.log("‚úÖ Toggle button exists/found");

                    toggleBtn.addEventListener("click", () => {
                        console.log("üî• Toggle button clicked");
                        toggleState();
                    });
                } else {
                    console.warn("‚ùå Toggle Button not found. Check ID or ensure the button exists.");
                }

            }

            function toggleState() {
                // Toggle the state
                toggled = !toggled;

                // Save the new state to localStorage
                localStorage.setItem('toggled', toggled);
                console.log(`Current state of the browser's page is: ${localStorage.getItem('toggled')}`)

                // Navigate to the appropriate page
                if (toggled) {
                    window.location.href = 'analytics.html';
                } else {
                    window.location.href = 'home.html';
                }
            }
            
        });
    </script>
</head>
<body>
    
    <header class="home-header">
        <div class="leftNav">
            <img src="./images/default.jpg" id="profile-pic" style="border-radius: 50%;" alt="" width="50" height="50">
            <h1 class="welcome">Welcome <span id="username"></span> </h1>
        </div>
        <div class="rightNav">
            <ul class="UnorderedList">
                <li><button id="analyticsBtn">Hide Analytics</button></li>
                <li><button id="logoutBtn">LogOut</button></li>
            </ul>
        </div>
    </header>

    <section class="main">
        <!-- Table to Display Tasks -->
        <div class="table-container">
            <table id="taskTable">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Tag</th>
                        <th>Color</th>
                        <th>Selected Boxes</th>
                        <th>Total Time</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    
        <!-- Charts for Analytics -->
        <div class="analytics">
            <h2>Analytics</h2>
            <div class="chart-container">
                <div class="chart">
                    <h3>Total Time Spent per Tag</h3>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart">
                    <h3>Task Distribution by Tag</h3>
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
            <div class="heatmap-container">
                <h3>Task Completion Over Time</h3>
                <div id="heatmap"></div>
            </div>
        </div>
    </section>

    <script type="module">
        // Get the URL parameters
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth,signInWithPopup, getRedirectResult, onAuthStateChanged, signInWithRedirect, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        // import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getFirestore, doc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { remove, ref, set, getDatabase, get, update, onValue } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
        

        // Firebase Configuration
        const firebaseConfig = {
        apiKey: "AIzaSyClF_kUmfMyrxDqP_iuu7BgoqqTtX67JRY",
        authDomain: "valutracker-391c6.firebaseapp.com",
        databaseURL: "https://valutracker-391c6-default-rtdb.firebaseio.com",
        projectId: "valutracker-391c6",
        storageBucket: "valutracker-391c6.firebasestorage.app",
        messagingSenderId: "268267434732",
        appId: "1:268267434732:web:49e075d9a0b22df4c4abc9",
        measurementId: "G-X8RX5C4WKS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Reference the Firebase Database
        const db = getDatabase(app);

        window.auth = auth;
        window.addDoc = addDoc;
        window.collection =collection;
        window.db = db;
        window.ref = ref;
        window.set = set;
        window.remove = remove;
        window.get = get;
        window.update = update;
            
        const urlParams = new URLSearchParams(window.location.search);
        
        // Retrieve the 'username' parameter
        const username = urlParams.get('username');
        
        // Display the username on the page
        document.getElementById('username').textContent = username;
    
        const logoutBtn = document.getElementById('logoutBtn');
        logoutBtn.addEventListener('click', () => {    
            // Sign out the user
            auth.signOut()
                .then(() => {
                    console.log('User signed out');
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Sign out error:', error);
                });
        });
    
        const profilePic = document.getElementById("profile-pic");
    
        onAuthStateChanged(auth, (user) => {
            console.log("üî• Auth State Changed:", user);
            console.log("User UID:", user.uid);


            if (user) {
                console.log("‚úÖ User signed in:", user.displayName, user.email, user.uid);
                window.userId = user.uid;

                // Set profile picture
                let checkPhotoInterval = setInterval(() => {
                    if (user.photoURL) {
                        console.log("üñº Found Profile Pic:", user.photoURL);
                        profilePic.src = user.photoURL;
                        clearInterval(checkPhotoInterval);
                    } else {
                        console.warn("‚ö† No photoURL found, using default.");
                        profilePic.src = "public/images/default.jpg";
                    }
                }, 100); 

                // Fetch tasks
                fetchTasks(user.uid);
            } else {
                console.warn("‚ùå No user is signed in.");
                window.location.href = 'index.html'; // Redirect to login page if user is not authenticated
            }
        });


        // Function to fetch and display tasks
        function fetchTasks(userId) {
            const userTasksRef = ref(db, `userTasks/${userId}`);

            onValue(userTasksRef, (snapshot) => {
                console.log("Fetching tasks for user:", userId);
                console.log("üìå Snapshot Data:", snapshot.val()); // Debugging

                const tableBody = document.querySelector("#taskTable tbody");
                tableBody.innerHTML = ""; // Clear previous rows

                const tagTimeMap = {}; // Total time per tag for bar chart
                const tagCountMap = {}; // Task count per tag for pie chart
                const tagColorMap = {}; // Color mapping for each tag

                if (snapshot.exists()) {
                    const tasks = snapshot.val();
                    
                    Object.keys(tasks).forEach((taskId) => {
                        const task = tasks[taskId]; // Access individual task object
                        
                        // Ensure task properties exist before accessing them
                        const taskText = task.task || "No task name";
                        const tag = task.tag || "No tag";
                        const color = task.color || "#CCCCCC"; // Default gray color
                        const selectedBoxes = Array.isArray(task.selectedBoxes) ? task.selectedBoxes.join(", ") : "N/A";
                        const totalTime = task.totalTime || 0;
                        const timestamp = task.timestamp ? new Date(task.timestamp).toLocaleString() : "N/A";

                        // Populate table
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${taskText}</td>
                            <td>${tag}</td>
                            <td style="background-color: ${color};"></td>
                            <td>${selectedBoxes}</td>
                            <td>${totalTime}</td>
                            <td>${timestamp}</td>
                        `;
                        tableBody.appendChild(row);

                        // Aggregate data for charts
                        tagTimeMap[tag] = (tagTimeMap[tag] || 0) + totalTime;
                        tagCountMap[tag] = (tagCountMap[tag] || 0) + 1;
                        tagColorMap[tag] = color; // Store tag color
                    });

                    // Update charts with real data
                    updateCharts(tagTimeMap, tagCountMap, tagColorMap);
                } else {
                    console.warn("‚ö† No tasks found for this user.");
                }
            });
        }


        // Function to update charts dynamically with colors from Firebase data
        function updateCharts(tagTimeMap, tagCountMap, tagColorMap) {
            const barCtx = document.getElementById("barChart").getContext("2d");
            const pieCtx = document.getElementById("pieChart").getContext("2d");

            // Prepare labels and data
            const tags = Object.keys(tagTimeMap);
            const totalTimeData = Object.values(tagTimeMap);
            const taskCountData = Object.values(tagCountMap);
            const tagColors = tags.map(tag => tagColorMap[tag] || "#CCCCCC"); // Default color if none found

            // Bar Chart - Total Time per Tag
            if (window.barChartInstance) {
                window.barChartInstance.destroy();
            }
            window.barChartInstance = new Chart(barCtx, {
                type: "bar",
                data: {
                    labels: tags,
                    datasets: [
                        {
                            label: "Total Time (minutes)",
                            data: totalTimeData,
                            backgroundColor: tagColors, // Use the tag's color
                            borderColor: tagColors.map(color => color.replace(/0.7/, "1")), // Darker border
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                },
            });

            // Pie Chart - Task Count per Tag
            if (window.pieChartInstance) {
                window.pieChartInstance.destroy();
            }
            window.pieChartInstance = new Chart(pieCtx, {
                type: "pie",
                data: {
                    labels: tags,
                    datasets: [
                        {
                            label: "Task Distribution",
                            data: taskCountData,
                            backgroundColor: tagColors, // Use the tag's color
                            borderWidth: 1,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                },
            });
        }


        // Render GitHub-like Green Boxes Heatmap
        const heatmapContainer = document.getElementById("heatmap");
        const heatmapGrid = document.createElement("div");
        heatmapGrid.className = "heatmap-grid";

        // Generate heatmap grid (e.g., 7 days x 52 weeks)
        for (let i = 0; i < 365; i++) {
            const box = document.createElement("div");
            box.className = "heatmap-box";
            const randomIntensity = Math.floor(Math.random() * 4); // Random intensity (0-3)
            box.style.backgroundColor = `rgba(0, 128, 0, ${0.25 * (randomIntensity + 1)})`;
            heatmapGrid.appendChild(box);
        }

        heatmapContainer.appendChild(heatmapGrid);
    </script>
</body>
</html>